stages:
  - security       # Snyk vulnerability scanning
  - quality        # SonarCloud code analysis
  - build-and-deploy

variables:
  # GitLab Container Registry
  REGISTRY: git.loopus.it:5050
  IMAGE_NAME: git.loopus.it:5050/arpa/arpa-api

# =============================================================================
# SECURITY STAGE - Snyk Vulnerability Scanning
# =============================================================================
snyk-scan:
  stage: security
  image: mcr.microsoft.com/dotnet/sdk:10.0
  before_script:
    - apt-get update && apt-get install -y nodejs npm
    - npm install -g snyk
    - dotnet restore
  script:
    - snyk auth $SNYK_TOKEN
    - snyk test --file=./Orso.Arpa.Api.sln --severity-threshold=medium || true
    - snyk monitor --file=./Orso.Arpa.Api.sln || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "raspi-dev" || $CI_COMMIT_BRANCH == "raspi-prod"

# =============================================================================
# QUALITY STAGE - SonarCloud Code Analysis
# =============================================================================
sonarcloud:
  stage: quality
  image: mcr.microsoft.com/dotnet/sdk:10.0
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: sonar-${CI_JOB_NAME}
    paths:
      - .sonar/cache
  before_script:
    - apt-get update && apt-get install -y openjdk-17-jre
    - dotnet tool install --global dotnet-sonarscanner
    - export PATH="$PATH:$HOME/.dotnet/tools"
  script:
    - |
      dotnet sonarscanner begin \
        /k:"orso-co_Orso.Arpa.Api" \
        /o:"orso-co" \
        /d:sonar.host.url="https://sonarcloud.io" \
        /d:sonar.token="${SONAR_TOKEN}"
    - dotnet build --configuration Release
    - dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "raspi-dev" || $CI_COMMIT_BRANCH == "raspi-prod"

# =============================================================================
# BUILD AND DEPLOY STAGE
# =============================================================================

# Build und Deploy in einem Job (direkt auf raspi3)
build-and-deploy:
  stage: build-and-deploy
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "raspi-dev" || $CI_COMMIT_BRANCH == "raspi-prod"
  before_script:
    - apk add --no-cache openssh-client git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # SSH Key aus base64 dekodieren
    - echo "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/deploy_key
    - chmod 600 ~/.ssh/deploy_key
    - ssh-keyscan -p 2222 ${SSH_HOST} >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      # Deployment-Variablen basierend auf Branch
      if [ "$CI_COMMIT_BRANCH" = "raspi-prod" ]; then
        DEPLOY_DIR="arpa-prod"
        IMAGE_TAG="raspi-prod"
      else
        DEPLOY_DIR="arpa"
        IMAGE_TAG="raspi-dev"
      fi

      echo "=== Building and deploying to ~/$DEPLOY_DIR ==="
      echo "Branch: $CI_COMMIT_BRANCH"
      echo "Image Tag: $IMAGE_TAG"

      # Git-URL mit CI-Token f체r authentifizierten Clone
      GIT_URL="https://gitlab-ci-token:${CI_JOB_TOKEN}@git.loopus.it/arpa/arpa-api.git"

      # Auf raspi3 bauen und deployen (ARM64 nativ)
      ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p 2222 ${SSH_USERNAME}@${SSH_HOST} << ENDSSH
        set -e
        cd ~/$DEPLOY_DIR

        echo "=== Pulling latest code ==="
        # Tempor채res Verzeichnis f체r Build
        BUILD_DIR="/tmp/arpa-build-\$\$"
        mkdir -p \$BUILD_DIR
        cd \$BUILD_DIR

        # Code klonen (mit CI-Token)
        git clone --depth 1 --branch $CI_COMMIT_BRANCH $GIT_URL .

        echo "=== Building Docker image ==="
        docker build --platform linux/arm64 -t arpa-api:$IMAGE_TAG .

        echo "=== Deploying ==="
        cd ~/$DEPLOY_DIR

        # docker-compose.yml auf lokales Image umstellen
        sed -i 's|image: ghcr.io/orso-co/orso-arpa-api:.*|image: arpa-api:'$IMAGE_TAG'|g' docker-compose.yml
        sed -i 's|image: arpa-api:.*|image: arpa-api:'$IMAGE_TAG'|g' docker-compose.yml

        # Container neu starten
        docker compose up -d --force-recreate api

        echo "=== Waiting for health check ==="
        for i in \$(seq 1 30); do
          if docker compose ps api | grep -q "healthy"; then
            echo "API is healthy!"
            break
          fi
          echo "Attempt \$i/30 - waiting..."
          sleep 5
        done

        # Status anzeigen
        docker compose ps

        # Aufr채umen
        rm -rf \$BUILD_DIR
        docker image prune -f

        echo "=== Deployment complete ==="
      ENDSSH
  tags:
    - docker
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://arpa.loopus.it
