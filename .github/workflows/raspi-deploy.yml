name: Build and Deploy to Raspberry Pi

on:
    push:
        branches: [ feature/raspi-workflow ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract branch name
              shell: bash
              run: echo "branch=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
              id: extract_branch

            - name: Build and push
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: |
                      ghcr.io/orso-co/orso-arpa-api:latest
                      ghcr.io/orso-co/orso-arpa-api:${{ steps.extract_branch.outputs.branch }}

    deploy:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Deploy to Raspberry Pi
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SSH_HOST }}
                  port: 2222
                  username: ${{ secrets.SSH_USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      # Bei GitHub Container Registry anmelden
                      echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u wolfgangroese --password-stdin
                      
                      cd ~/arpa
                      docker-compose pull
                      docker-compose up -d
